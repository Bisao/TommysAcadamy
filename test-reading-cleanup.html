<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Cleanup da Leitura</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .test-section.pass {
            border-color: #4CAF50;
            background: #f1f8e9;
        }
        .test-section.fail {
            border-color: #f44336;
            background: #ffebee;
        }
        button {
            background: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #1976D2;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .status.info {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status.success {
            background: #e8f5e8;
            color: #2e7d32;
        }
        .status.error {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üß™ Teste de Cleanup do Sistema de Leitura</h1>
        <p>Este teste verifica se o √°udio para automaticamente quando o usu√°rio sai da p√°gina de leitura.</p>
        
        <div class="test-section" id="cleanup-test">
            <h3>üìã Teste de Cleanup Autom√°tico</h3>
            <div id="test-status" class="status info">
                Aguardando in√≠cio do teste...
            </div>
            
            <button onclick="startReadingTest()">Iniciar Teste de Leitura</button>
            <button onclick="simulatePageUnload()">Simular Sa√≠da da P√°gina</button>
            <button onclick="checkSpeechStatus()">Verificar Status do √Åudio</button>
            <button onclick="openReadingPage()">Abrir P√°gina de Leitura Real</button>
            
            <div id="test-results">
                <h4>Resultados dos Testes:</h4>
                <ul id="results-list"></ul>
            </div>
        </div>

        <div class="test-section">
            <h3>üéØ Funcionalidades Testadas</h3>
            <ul>
                <li><strong>beforeunload:</strong> Para o √°udio quando o usu√°rio navega para outra p√°gina</li>
                <li><strong>visibilitychange:</strong> Pausa o √°udio quando a aba fica em segundo plano</li>
                <li><strong>Component unmount:</strong> Limpa todos os recursos quando o componente √© desmontado</li>
                <li><strong>Speech synthesis cleanup:</strong> Cancela s√≠ntese de voz em andamento</li>
            </ul>
        </div>
    </div>

    <script>
        let testUtterance = null;
        let testResults = [];

        function addResult(test, passed, message) {
            const li = document.createElement('li');
            li.style.color = passed ? 'green' : 'red';
            li.innerHTML = `${passed ? '‚úÖ' : '‚ùå'} <strong>${test}:</strong> ${message}`;
            document.getElementById('results-list').appendChild(li);
            testResults.push({ test, passed, message });
        }

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('test-status');
            statusEl.className = `status ${type}`;
            statusEl.textContent = message;
        }

        function startReadingTest() {
            updateStatus('Iniciando teste de s√≠ntese de voz...', 'info');
            
            if (!('speechSynthesis' in window)) {
                addResult('Suporte do Browser', false, 'Speech Synthesis n√£o suportado neste navegador');
                updateStatus('Erro: Speech Synthesis n√£o suportado', 'error');
                return;
            }

            // Testar se o speech synthesis funciona
            testUtterance = new SpeechSynthesisUtterance('Este √© um teste do sistema de leitura guiada. O √°udio deve parar automaticamente quando voc√™ sair da p√°gina.');
            testUtterance.rate = 0.8;
            testUtterance.lang = 'pt-BR';
            
            testUtterance.onstart = () => {
                addResult('In√≠cio da S√≠ntese', true, '√Åudio iniciado com sucesso');
                updateStatus('√Åudio est√° tocando. Teste simular sa√≠da da p√°gina.', 'success');
            };
            
            testUtterance.onend = () => {
                addResult('Fim da S√≠ntese', true, '√Åudio terminou naturalmente');
                updateStatus('√Åudio terminou. Pronto para pr√≥ximo teste.', 'info');
            };
            
            testUtterance.onerror = (event) => {
                addResult('Erro na S√≠ntese', false, `Erro: ${event.error}`);
                updateStatus(`Erro no √°udio: ${event.error}`, 'error');
            };

            speechSynthesis.speak(testUtterance);
            addResult('Configura√ß√£o do Teste', true, 'Utterance criada e iniciada');
        }

        function simulatePageUnload() {
            updateStatus('Simulando sa√≠da da p√°gina...', 'info');
            
            // Verificar se h√° √°udio tocando antes
            const wasSpeaking = speechSynthesis.speaking;
            
            if (!wasSpeaking) {
                addResult('Estado Inicial', false, 'Nenhum √°udio estava tocando para testar');
                updateStatus('Inicie o teste de leitura primeiro', 'error');
                return;
            }

            // Simular o que acontece no componente ReadingLesson
            console.log("Simulando page unload - stopping speech synthesis");
            speechSynthesis.cancel();
            
            // Verificar se parou
            setTimeout(() => {
                const isStillSpeaking = speechSynthesis.speaking;
                if (!isStillSpeaking) {
                    addResult('Cleanup no Unload', true, '√Åudio parou corretamente ao simular sa√≠da da p√°gina');
                    updateStatus('‚úÖ Teste passou: √Åudio parou automaticamente', 'success');
                } else {
                    addResult('Cleanup no Unload', false, '√Åudio n√£o parou ao simular sa√≠da da p√°gina');
                    updateStatus('‚ùå Teste falhou: √Åudio continuou tocando', 'error');
                }
            }, 100);
        }

        function checkSpeechStatus() {
            const status = {
                speaking: speechSynthesis.speaking,
                paused: speechSynthesis.paused,
                pending: speechSynthesis.pending
            };
            
            const statusText = `Speaking: ${status.speaking}, Paused: ${status.paused}, Pending: ${status.pending}`;
            addResult('Status do Speech Synthesis', true, statusText);
            updateStatus(`Status atual: ${statusText}`, 'info');
        }

        function openReadingPage() {
            const readingUrl = window.location.origin + '/reading';
            updateStatus('Abrindo p√°gina de leitura real...', 'info');
            window.open(readingUrl, '_blank');
            addResult('Navega√ß√£o', true, 'P√°gina de leitura aberta em nova aba');
        }

        // Simular event listeners que existem no componente real
        window.addEventListener('beforeunload', () => {
            console.log('beforeunload event fired - would stop reading in real app');
        });

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                console.log('Page hidden - would pause reading in real app');
            } else {
                console.log('Page visible again');
            }
        });

        // Teste autom√°tico ao carregar
        window.addEventListener('load', () => {
            updateStatus('P√°gina de teste carregada. Clique nos bot√µes para testar.', 'info');
            addResult('Inicializa√ß√£o', true, 'P√°gina de teste carregada com sucesso');
        });
    </script>
</body>
</html>